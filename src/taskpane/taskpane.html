<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Clio Matter Insert</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f7f7f7;
      padding: 0;
      margin: 0;
      overflow-x: hidden;
    }
  </style>
</head>
<body>
  <div id="app" class="p-4 h-screen flex flex-col">
    <header class="pb-4 mb-4 border-b border-gray-200">
      <h1 class="text-xl font-bold text-gray-800">Clio Matter Data</h1>
      <p id="auth-status-text" class="text-sm text-gray-500">Initializing...</p>
    </header>

    <div id="auth-area" class="flex-grow flex flex-col items-center justify-center p-8 text-center hidden">
      <p class="mb-4 text-gray-600">Please connect to Clio.</p>
      <button id="auth-button" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded">
        Connect to Clio
      </button>
    </div>

    <div id="matter-list-container" class="space-y-4 overflow-y-auto flex-grow pb-4 hidden">
      <p id="loading-status" class="text-center text-sm text-gray-500 p-8">Loading matter data...</p>
    </div>

    <div id="message-box" class="mt-auto p-3 bg-blue-100 text-blue-800 text-sm rounded hidden"></div>
  </div>

<script>
  Office.onReady(() => {
    const authArea = document.getElementById('auth-area');
    const authButton = document.getElementById('auth-button');
    const matterListContainer = document.getElementById('matter-list-container');
    const loadingStatus = document.getElementById('loading-status');
    const authStatusText = document.getElementById('auth-status-text');
    const messageBox = document.getElementById('message-box');

    // Use absolute URL for dialogs to avoid origin ambiguity inside Office host
    const ORIGIN = window.location.origin;
    const CLIO_AUTH_START_URL = `$/.netlify/functions/auth-start`;
    const CLIO_MATTER_API_URL = `$/.netlify/functions/matter-proxy`;

    let authDialog = null;

    async function fetchAndRenderMatters() {
      authArea?.classList.add('hidden');
      matterListContainer?.classList.remove('hidden');
      loadingStatus.textContent = "Loading matters from Clio...";
      authStatusText.textContent = "Connected. Fetching data...";

      try {
        // Add a short delay to allow cookie propagation after auth
        await new Promise(resolve => setTimeout(resolve, 500));
        
        const res = await fetch(CLIO_MATTER_API_URL, { credentials: "include" });
        if (!res.ok) throw new Error("Not authorized");

        const data = await res.json();
        // Check for Clio's typical data structure, or assume the array is the top level
        const matters = data.data || data.matters || [];

        if (matterListContainer) {
          matterListContainer.innerHTML = '';
          if (!matters.length) {
            matterListContainer.innerHTML = '<p class="text-center text-gray-500">No open matters found.</p>';
          } else {
            matters.forEach((m) => {
              const card = document.createElement('div');
              card.className = 'bg-white p-4 rounded shadow border';
              card.innerHTML = `
                <div class="mb-2">
                  <h2 class="text-lg font-semibold text-indigo-700">${m.matterName || m.display_number}</h2>
                  <p class="text-sm text-gray-600">Client: ${m.client?.name || 'N/A'}</p>
                  <p class="text-sm text-gray-600">ID: ${m.id}</p>
                </div>
                <div class="flex gap-2 mt-2">
                  <button class="insert-btn bg-indigo-600 text-white px-3 py-1 text-xs rounded hover:bg-indigo-700 transition" data-value="${m.client?.name || ''}">Insert Client</button>
                  <button class="insert-btn bg-indigo-600 text-white px-3 py-1 text-xs rounded hover:bg-indigo-700 transition" data-value="${m.matterName || m.display_number}">Insert Matter</button>
                </div>
              `;
              card.querySelectorAll('.insert-btn').forEach(btn => {
                btn.addEventListener('click', () => insertDataIntoWord(btn.dataset.value));
              });
              matterListContainer.appendChild(card);
            });
          }
          authStatusText.textContent = `Authenticated (${matters.length} matters)`;
        }
      } catch (e) {
        console.error("Fetch Matters Error:", e);
        matterListContainer?.classList.add('hidden');
        authArea?.classList.remove('hidden');
        authStatusText.textContent = "Disconnected. Please connect to Clio.";
      }
    }

    async function insertDataIntoWord(text) {
      if (!text || !messageBox) return;

      try {
        await Word.run(async (context) => {
          const range = context.document.getSelection();
          range.insertText(text + "\n", Word.InsertLocation.after);
          await context.sync();
          messageBox.textContent = `Inserted: "${text}"`;
          messageBox.classList.remove("hidden");
          setTimeout(() => messageBox.classList.add("hidden"), 3000);
        });
      } catch (err) {
        console.error(err);
        messageBox.textContent = "Error: Could not insert content.";
        messageBox.classList.remove("hidden");
      }
    }

    function authenticateWithClio() {
      Office.context.ui.displayDialogAsync(
        CLIO_AUTH_START_URL,
        // Updated to better size the dialog (80% height, 60% width)
        // The default is a separate popup window, which works for OAuth
        { height: 80, width: 60 },
        (res) => {
          if (res.status !== Office.AsyncResultStatus.Succeeded) {
            console.error("Dialog failed to open", res.error);
            messageBox.textContent = "Error: Authentication popup failed to open or was blocked.";
            messageBox.classList.remove("hidden");
            return;
          }
          authDialog = res.value;

          // Success/error message from auth-callback page
          authDialog.addEventHandler(Office.EventType.DialogMessageReceived, (arg) => {
            try {
              // The message should be a JSON string from auth-callback.js
              const payload = JSON.parse(arg.message);
              
              // Dialog is already closed by messageParent in auth-callback.js, but check just in case.
              if (authDialog) {
                authDialog.close();
                authDialog = null;
              }

              if (payload && payload.ok) {
                fetchAndRenderMatters();
              } else {
                authStatusText.textContent = "Authorization failed. Check Clio credentials.";
                authArea?.classList.remove('hidden');
              }
            } catch (e) {
              // This handles the raw URL redirect from Clio failing to close the dialog
              console.error("Error processing dialog message:", e, "Message:", arg.message);
              if (authDialog) { authDialog.close(); authDialog = null; }
              fetchAndRenderMatters(); // Try fetching matters anyway, as the cookie may be set
            }
          });

          // User closed dialog manually (DialogEventReceived is the correct event type)
          authDialog.addEventHandler(Office.EventType.DialogEventReceived, () => {
            if (authDialog) { authDialog.close(); authDialog = null; }
            // No state change—remain on auth screen
          });
        }
      );
    }

    if (authButton) {
      authButton.addEventListener("click", authenticateWithClio);
    }

    // Initial check to see if the user is already authenticated
    fetchAndRenderMatters();
  });
</script>
</body>
</html>
